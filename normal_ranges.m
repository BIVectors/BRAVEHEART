%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BRAVEHEART - Open source software for electrocardiographic and vectorcardiographic analysis
% normal_ranges.m -- Calculate normal ranges based on age, gender, BMI, race
% Copyright 2016-2023 Hans F. Stabenau and Jonathan W. Waks
% 
% Source code/executables: https://github.com/BIVectors/BRAVEHEART
% Contact: braveheart.ecg@gmail.com
% 
% BRAVEHEART is free software: you can redistribute it and/or modify it under the terms of the GNU 
% General Public License as published by the Free Software Foundation, either version 3 of the License, 
% or (at your option) any later version.
%
% BRAVEHEART is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; 
% without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. 
% See the GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License along with this program. 
% If not, see <https://www.gnu.org/licenses/>.
%
% This software is for research purposes only and is not intended to diagnose or treat any disease.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function vals = normal_ranges(c_age, gender, c_bmi, c_hr, white)

% Gender
if strcmp(gender,'MALE')
    male = 1;
else
    male = 0;
end

% Split continuous variables into groups"

% Age
age1 = round(c_age);
if age1 <= 29 
    age = 1;
elseif age1 <= 39
    age = 2;
elseif age1 <= 49
    age = 3;
elseif age1 <= 59
    age = 4;
elseif age1 <= 69
    age = 5;
else 
    age = 6;
end

% BMI
bmi1 = round(c_bmi);
if bmi1 <= 20
    bmi = 1;
elseif bmi1 <= 30
    bmi = 2;
elseif bmi1 <= 40
    bmi = 3;
elseif bmi1 <= 50
    bmi = 4;
else 
    bmi = 5;
end

% HR

hr1 = round(c_hr);
if hr1 <= 60 
    hr = 1;
elseif hr1 <= 65
    hr = 2;
elseif hr1 <= 70
    hr = 3;
elseif hr1 <= 75 
    hr = 4;
elseif hr1 <= 80
    hr = 5;
else
    hr = 6;
end



% List the fieldnames you want to use here.  Keep consistent with
% covariance matrices, beta coefficients etc
fn = [{'svg_area_mag'}...
      {'svg_area_az'}...
      {'svg_area_el'}...
      {'sai_qrst'}...
      {'sai_vm'}...
      {'svg_x'}...
      {'svg_y'}...
      {'svg_z'}...
      {'qrst_angle_area'}...
      {'qrst_angle_peak'}...   
      ];

  
  

% Covarience matrices - (name as co.{fn})
co.svg_area_mag = ...
    [11.552843,.28131863,-.57266504,.67915863,-2.1042011,.21662913,-.29269508,.0077505913,-3.4447281;...
    .28131863,.072714388,.00082208321,.0048356554,.00020196641,.0093308492,-.00031583433,-.021458345,-.27058482;...
    -.57266504,.00082208321,.14290681,-.0010296009,.0077058813,.00005271257,.011954717,-.018983731,.0097929034;...
    .67915863,.0048356554,-.0010296009,.31374452,-.00025294858,-.01615357,.00039556006,.026875053,-.69260198;...
    -2.1042011,.00020196641,.0077058813,-.00025294858,.96433753,.000012950232,-.042783178,-.0046638539,.0024058849;...
    .21662913,.0093308492,.00005271257,-.01615357,.000012950232,.062259957,-.000020251526,-.0013759246,-.21594088;...
    -.29269508,-.00031583433,.011954717,.00039556006,-.042783178,-.000020251526,.11414534,.0072933175,-.0037623139;...
    .0077505913,-.021458345,-.018983731,.026875053,-.0046638539,-.0013759246,.0072933175,.49552092,-.25561827;...
    -3.4447281,-.27058482,.0097929034,-.69260198,.0024058849,-.21594088,-.0037623139,-.25561827,3.5725925];

co.svg_area_az = ...
    [7.9481654,.1935426,-.39398411,.46724996,-1.4476557,.14903727,-.20136939,.005332279,-2.3699162;...
    .1935426,.050026305,.00056557968,.0033268514,.00013894957,.0064194705,-.00021728882,-.014762987,-.18615791;...
    -.39398411,.00056557968,.098317541,-.00070834841,.0053015193,.000036265381,.0082246484,-.013060494,.0067373561;...
    .46724996,.0033268514,-.00070834841,.21585105,-.00017402446,-.01111339,.0002721388,.018489594,-.47649875;...
    -1.4476557,.00013894957,.0053015193,-.00017402446,.66344833,8.9095465e-06,-.029434122,-.0032086547,.0016552092;...
    .14903727,.0064194705,.000036265381,-.01111339,8.9095465e-06,.042833824,-.000013932717,-.00094661344,-.14856377;...
    -.20136939,-.00021728882,.0082246484,.0002721388,-.029434122,-.000013932717,.078530118,.0050176824,-.0025884099;...
    .005332279,-.014762987,-.013060494,.018489594,-.0032086547,-.00094661344,.0050176824,.34091026,-.17586116;...
    -2.3699162,-.18615791,.0067373561,-.47649875,.0016552092,-.14856377,-.0025884099,-.17586116,2.4578848];

co.svg_area_el = ...
    [2.911231,.070890225,-.14430736,.17114297,-.5302431,.054588944,-.073756993,.0019530917,-.86804605;...
    .070890225,.01832349,.0002071589,.0012185494,.000050894043,.0023513052,-.000079587917,-.0054073445,-.068185382;...
    -.14430736,.0002071589,.036011465,-.0002594518,.0019418251,.000013283178,.0030125005,-.0047837598,.0024677394;...
    .17114297,.0012185494,-.0002594518,.0790613,-.000063741179,-.0040705805,.000099678218,.0067723147,-.17453058;...
    -.5302431,.000050894043,.0019418251,-.000063741179,.24300593,3.2633629e-06,-.010781045,-.0011752568,.00060626521;...
    .054588944,.0023513052,.000013283178,-.0040705805,3.2633629e-06,.015689049,-5.1032348e-06,-.00034672284,-.054415505;...
    -.073756993,-.000079587917,.0030125005,.000099678218,-.010781045,-5.1032348e-06,.028763782,.0018378622,-.00094807532;...
    .0019530917,-.0054073445,-.0047837598,.0067723147,-.0011752568,-.00034672284,.0018378622,.12486762,-.06441392;...
    -.86804605,-.068185382,.0024677394,-.17453058,.00060626521,-.054415505,-.00094807532,-.06441392,.90026695];


co.sai_qrst = ...
    [28.449026	0.69275081	-1.4101951	1.672437	-5.1816225	0.53345203	-0.72076541	0.019085933	-8.482688;...
    0.69275081	0.17906013	0.002024391	0.011907864	0.000497345	0.022977337	-0.000777746	-0.052841451	-0.66631866;...
    -1.4101951	0.002024391	0.35190991	-0.002535405	0.018975833	0.000129805	0.029438647	-0.046747684	0.024115153;...
    1.672437	0.011907864	-0.002535405	0.77259994	-0.000622889	-0.039778378	0.000974072	0.06618017	-1.7055414;...
    -5.1816225	0.000497345	0.018975833	-0.000622889	2.3746936	3.18901E-05	-0.10535413	-0.011484801	0.005924523;...
    0.53345203	0.022977337	0.000129805	-0.039778378	3.18901E-05	0.15331595	-4.98696E-05	-0.003388232	-0.53175724;...
    -0.72076541	-0.000777746	0.029438647	0.000974072	-0.10535413	-4.98696E-05	0.28108439	0.017959889	-0.009264747;...
    0.019085933	-0.052841451	-0.046747684	0.06618017	-0.011484801	-0.003388232	0.017959889	1.2202268	-0.62946332;...
    -8.482688	-0.66631866	0.024115153	-1.7055414	0.005924523	-0.53175724	-0.009264747	-0.62946332	8.7975559];


co.sai_vm = ...
    [11.261879	0.27423349	-0.5582422	0.6620537	-2.0512056	0.21117322	-0.28532338	0.007555388	-3.3579707;...
    0.27423349	0.070883043	0.000801379	0.004713867	0.00019688	0.009095847	-0.00030788	-0.020917905	-0.26377001;...
    -0.5582422	0.000801379	0.13930763	-0.00100367	0.007511804	5.1385E-05	0.011653631	-0.018505616	0.009546264;...
    0.6620537	0.004713867	-0.00100367	0.3058427	-0.000246578	-0.015746733	0.000385598	0.02619819	-0.67515844;...
    -2.0512056	0.00019688	0.007511804	-0.000246578	0.94005018	1.26241E-05	-0.041705661	-0.004546392	0.002345291;...
    0.21117322	0.009095847	5.1385E-05	-0.015746733	1.26241E-05	0.060691908	-1.97415E-05	-0.001341271	-0.2105023;...
    -0.28532338	-0.00030788	0.011653631	0.000385598	-0.041705661	-1.97415E-05	0.11127053	0.007109632	-0.003667558;...
    0.007555388	-0.020917905	-0.018505616	0.02619819	-0.004546392	-0.001341271	0.007109632	0.48304099	-0.24918039;...
    -3.3579707	-0.26377001	0.009546264	-0.67515844	0.002345291	-0.2105023	-0.003667558	-0.24918039	3.482615];


co.svg_x = ...
    [8.1080179	0.1974351	-0.40190786	0.47664723	-1.4767706	0.15203469	-0.2054193	0.005439521	-2.4175797;...
    0.1974351	0.051032424	0.000576955	0.003393761	0.000141744	0.006548578	-0.000221659	-0.015059899	-0.18990189;...
    -0.40190786	0.000576955	0.10029489	-0.000722595	0.005408143	3.69947E-05	0.008390062	-0.013323165	0.006872857;...
    0.47664723	0.003393761	-0.000722595	0.22019222	-0.000177524	-0.011336901	0.000277612	0.018861454	-0.48608205;...
    -1.4767706	0.000141744	0.005408143	-0.000177524	0.67679149	9.09E-06	-0.030026097	-0.003273187	0.001688499;...
    0.15203469	0.006548578	3.69947E-05	-0.011336901	9.09E-06	0.043695293	-1.42129E-05	-0.000965652	-0.15155166;...
    -0.2054193	-0.000221659	0.008390062	0.000277612	-0.030026097	-1.42129E-05	0.080109499	0.005118597	-0.002640468;...
    0.005439521	-0.015059899	-0.013323165	0.018861454	-0.003273187	-0.000965652	0.005118597	0.34776658	-0.17939806;...
    -2.4175797	-0.18990189	0.006872857	-0.48608205	0.001688499	-0.15155166	-0.002640468	-0.17939806	2.5073175];


co.svg_y = ...
    [5.7887626	0.14095984	-0.28694427	0.34030482	-1.0543482	0.10854597	-0.14666019	0.003883575	-1.7260438;...
    0.14095984	0.03643487	0.00041192	0.002422993	0.000101199	0.004675392	-0.000158255	-0.010752095	-0.13558146;...
    -0.28694427	0.00041192	0.07160607	-0.0005159	0.003861172	2.64126E-05	0.005990129	-0.009512144	0.004906913;...
    0.34030482	0.002422993	-0.0005159	0.15720741	-0.000126745	-0.008094041	0.000198203	0.013466235	-0.34704086;...
    -1.0543482	0.000101199	0.003861172	-0.000126745	0.48319888	6.49E-06	-0.021437291	-0.002336909	0.001205512;...
    0.10854597	0.004675392	2.64126E-05	-0.008094041	6.49E-06	0.031196486	-1.01474E-05	-0.000689432	-0.10820111;...
    -0.14666019	-0.000158255	0.005990129	0.000198203	-0.021437291	-1.01474E-05	0.057194605	0.00365445	-0.001885176;...
    0.003883575	-0.010752095	-0.009512144	0.013466235	-0.002336909	-0.000689432	0.00365445	0.24828979	-0.1280822;...
    -1.7260438	-0.13558146	0.004906913	-0.34704086	0.001205512	-0.10820111	-0.001885176	-0.1280822	1.7901126];


co.svg_z = ...
    [5.3408675	0.13005333	-0.26474246	0.31397438	-0.97277004	0.10014743	-0.13531265	0.003583091	-1.5924944;...
    0.13005333	0.03361579	0.000380048	0.002235519	9.33689E-05	0.004313642	-0.00014601	-0.009920172	-0.12509111;...
    -0.26474246	0.000380048	0.066065684	-0.000475983	0.003562421	2.4369E-05	0.005526654	-0.00877616	0.004527249;...
    0.31397438	0.002235519	-0.000475983	0.14504378	-0.000116938	-0.007467779	0.000182867	0.01242431	-0.32018921;...
    -0.97277004	9.33689E-05	0.003562421	-0.000116938	0.44581228	5.99E-06	-0.01977862	-0.002156095	0.001112238;...
    0.10014743	0.004313642	2.4369E-05	-0.007467779	5.99E-06	0.028782716	-9.36E-06	-0.000636089	-0.099829249;...
    -0.13531265	-0.00014601	0.005526654	0.000182867	-0.01977862	-9.36E-06	0.052769277	0.003371693	-0.001739314;...
    0.003583091	-0.009920172	-0.00877616	0.01242431	-0.002156095	-0.000636089	0.003371693	0.22907883	-0.11817207;...
    -1.5924944	-0.12509111	0.004527249	-0.32018921	0.001112238	-0.099829249	-0.001739314	-0.11817207	1.651606];

% If using quantile regression don't need covariance matrix - set to NaN to
% allow automatation based on fieldnames
co.qrst_angle_area = nan;
co.qrst_angle_peak = nan;   



% Beta values - name as b.{fn}
b.svg_area_mag = [38.930878,-3.4791028,-6.3078127,-.3741934,-5.9471164,-3.573477,-6.2371635,-2.1910613,81.129951];
b.svg_area_az = [-23.205978,-.43301335,.20661356,2.9491813,6.3558631,1.3314525,1.0256872,.87140101,-9.9238596];
b.svg_area_el = [5.0910411,1.0183166,1.5028759,.84528166,.7230193,.20332627,-.35090098,.27557954,49.69381];
b.sai_qrst = [84.660522	-4.0657501	-11.293641	-0.78662276	-11.988871	-5.0925899	-8.5140705	-1.4244385	147.40816];
b.sai_vm = [51.133476	-2.6088743	-6.9922128	-0.34820738	-6.6559691	-3.224983	-5.4921699	-1.0615788	95.038399];
b.svg_x = [29.76606	-2.429966	-4.5066972	0.34939185	-3.2482982	-2.7915943	-5.1044927	-1.4327567	61.073219];
b.svg_y = [14.792278	-2.7105224	-4.4666519	-0.96354121	-4.0608282	-2.1188722	-2.6798096	-1.5918379	50.568153];
b.svg_z =[-29.609602	-0.34151033	1.1860994	2.5817442	5.7517624	0.90054101	2.102083	0.89211744	-8.8657351];

b_low.qrst_angle_peak = [4.6298013	0.13807175	-0.66595805	0.063598759	-0.31955284	-0.012963356	0.18818152	0.62606257	2.5822346];
b_high.qrst_angle_peak = [-18.119688	5.3406715	7.8262224	-0.91181511	24.082241	1.3939925	0.37160888	-6.2068076	39.974701];

b_low.qrst_angle_area = [1.1458352	0.6622256	0.71477711	0.75951266	0.44474724	-0.25443366	0.8888582	1.0568991	3.8933649];
b_high.qrst_angle_area = [9.0865755	6.5359063	0.38546589	-3.8999765	3.4395711	1.0105797	4.5686803	6.611362	70.683975];



% RMSE - name as RMSE.{fn}
RMSE.svg_area_mag = 18.064168;
RMSE.svg_area_az = 14.983283;
RMSE.svg_area_el = 9.0680076;
RMSE.sai_qrst = 28.347009;
RMSE.sai_vm = 17.83524;
RMSE.svg_x = 15.133204;
RMSE.svg_y = 12.786933;
RMSE.svg_z = 12.282293;
RMSE.qrst_angle_area = nan;
RMSE.qrst_angle_peak = nan;


% Value for CI
Talpha = 1.961;     % 1.961 corresponds to 95% CI
                    % 2.054 corresponds to 96% CI

% Regression values
x = [male, age*(1-male), age*male, bmi*(1-male), bmi*male, hr*(1-male), hr*male, white, 1]; 



for i = 1:length(fn)
    
    if ~isnan(co.(fn{i}))
    
        est.(fn{i}) = dot(b.(fn{i}),x);    
        stderrp2.(fn{i}) = dot(x, x*co.(fn{i}));
        stderrf.(fn{i}) = sqrt(RMSE.(fn{i})*RMSE.(fn{i}) + stderrp2.(fn{i}));    
        nml_low.(fn{i}) = est.(fn{i})-(Talpha*stderrf.(fn{i}));
        nml_high.(fn{i}) = est.(fn{i})+(Talpha*stderrf.(fn{i}));
    
    else
        nml_low.(fn{i}) = dot(b_low.(fn{i}),x);
        nml_high.(fn{i}) = dot(b_high.(fn{i}),x);
        
    end
end


vals.low = nml_low;
vals.high = nml_high;
vals.est = est;
